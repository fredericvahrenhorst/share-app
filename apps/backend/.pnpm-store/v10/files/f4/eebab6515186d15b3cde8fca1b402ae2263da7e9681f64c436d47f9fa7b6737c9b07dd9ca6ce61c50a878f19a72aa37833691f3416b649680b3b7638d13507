{"version":3,"file":"buildVersionFields.js","names":["RenderServerComponent","dequal","MissingEditorProp","fieldIsID","fieldShouldBeLocalized","getUniqueListBy","tabHasName","diffComponents","getFieldPathsModified","buildVersionFields","clientSchemaMap","customDiffComponents","entitySlug","fieldPermissions","fields","i18n","modifiedOnly","nestingLevel","parentIndexPath","parentIsLocalized","parentPath","parentSchemaPath","req","selectedLocales","versionFromSiblingData","versionToSiblingData","versionFields","fieldIndex","field","indexPath","path","schemaPath","index","clientField","get","payload","logger","error","clientFieldKey","clientSchemaMapKeys","Array","from","keys","msg","Error","versionField","isLocalized","fieldName","name","valueFrom","valueTo","fieldByLocale","locale","localizedVersionField","buildVersionField","baseVersionField","localized","Object","length","push","hasPermission","read","subFieldPermissions","CustomComponent","type","editor","CellComponent","DiffComponent","admin","components","Diff","DefaultComponent","tabs","tabIndex","tab","isNamedTab","tabAsField","tabIndexPath","tabPath","tabSchemaPath","tabVersion","label","maxLength","Math","max","isArray","rows","i","fromRow","toRow","blockSlugToMatch","blockType","toBlock","blocks","blockReferences","find","block","slug","fromBlockSlugToMatch","fromBlock","clientDiffProps","undefined","comparisonValue","diffMethod","versionValue","serverDiffProps","clientProps","Component","Fallback","importMap","key","serverProps"],"sources":["../../../../src/views/Version/RenderFieldsToDiff/buildVersionFields.tsx"],"sourcesContent":["import type { I18nClient } from '@payloadcms/translations'\n\nimport { RenderServerComponent } from '@payloadcms/ui/elements/RenderServerComponent'\nimport { dequal } from 'dequal/lite'\nimport {\n  type BaseVersionField,\n  type ClientField,\n  type ClientFieldSchemaMap,\n  type Field,\n  type FieldDiffClientProps,\n  type FieldDiffServerProps,\n  type FieldTypes,\n  type FlattenedBlock,\n  MissingEditorProp,\n  type PayloadComponent,\n  type PayloadRequest,\n  type SanitizedFieldPermissions,\n  type VersionField,\n} from 'payload'\nimport { fieldIsID, fieldShouldBeLocalized, getUniqueListBy, tabHasName } from 'payload/shared'\n\nimport { diffComponents } from './fields/index.js'\nimport { getFieldPathsModified } from './utilities/getFieldPathsModified.js'\n\nexport type BuildVersionFieldsArgs = {\n  clientSchemaMap: ClientFieldSchemaMap\n  customDiffComponents: Partial<\n    Record<FieldTypes, PayloadComponent<FieldDiffServerProps, FieldDiffClientProps>>\n  >\n  entitySlug: string\n  fieldPermissions:\n    | {\n        [key: string]: SanitizedFieldPermissions\n      }\n    | true\n  fields: Field[]\n  i18n: I18nClient\n  modifiedOnly: boolean\n  nestingLevel?: number\n  parentIndexPath: string\n  parentIsLocalized: boolean\n  parentPath: string\n  parentSchemaPath: string\n  req: PayloadRequest\n  selectedLocales: string[]\n  versionFromSiblingData: object\n  versionToSiblingData: object\n}\n\n/**\n * Build up an object that contains rendered diff components for each field.\n * This is then sent to the client to be rendered.\n *\n * Here, the server is responsible for traversing through the document data and building up this\n * version state object.\n */\nexport const buildVersionFields = ({\n  clientSchemaMap,\n  customDiffComponents,\n  entitySlug,\n  fieldPermissions,\n  fields,\n  i18n,\n  modifiedOnly,\n  nestingLevel = 0,\n  parentIndexPath,\n  parentIsLocalized,\n  parentPath,\n  parentSchemaPath,\n  req,\n  selectedLocales,\n  versionFromSiblingData,\n  versionToSiblingData,\n}: BuildVersionFieldsArgs): {\n  versionFields: VersionField[]\n} => {\n  const versionFields: VersionField[] = []\n  let fieldIndex = -1\n\n  for (const field of fields) {\n    fieldIndex++\n\n    if (fieldIsID(field)) {\n      continue\n    }\n\n    const { indexPath, path, schemaPath } = getFieldPathsModified({\n      field,\n      index: fieldIndex,\n      parentIndexPath,\n      parentPath,\n      parentSchemaPath,\n    })\n\n    const clientField = clientSchemaMap.get(entitySlug + '.' + schemaPath)\n\n    if (!clientField) {\n      req.payload.logger.error({\n        clientFieldKey: entitySlug + '.' + schemaPath,\n        clientSchemaMapKeys: Array.from(clientSchemaMap.keys()),\n        msg: 'No client field found for ' + entitySlug + '.' + schemaPath,\n        parentPath,\n        parentSchemaPath,\n        path,\n        schemaPath,\n      })\n      throw new Error('No client field found for ' + entitySlug + '.' + schemaPath)\n    }\n\n    const versionField: VersionField = {}\n    const isLocalized = fieldShouldBeLocalized({ field, parentIsLocalized })\n\n    const fieldName: null | string = 'name' in field ? field.name : null\n\n    const valueFrom = fieldName ? versionFromSiblingData?.[fieldName] : versionFromSiblingData\n    const valueTo = fieldName ? versionToSiblingData?.[fieldName] : versionToSiblingData\n\n    if (isLocalized) {\n      versionField.fieldByLocale = {}\n\n      for (const locale of selectedLocales) {\n        const localizedVersionField = buildVersionField({\n          clientField: clientField as ClientField,\n          clientSchemaMap,\n          customDiffComponents,\n          entitySlug,\n          field,\n          fieldPermissions,\n          i18n,\n          indexPath,\n          locale,\n          modifiedOnly,\n          nestingLevel,\n          parentIsLocalized: true,\n          parentPath,\n          parentSchemaPath,\n          path,\n          req,\n          schemaPath,\n          selectedLocales,\n          valueFrom: valueFrom?.[locale],\n          valueTo: valueTo?.[locale],\n        })\n        if (localizedVersionField) {\n          versionField.fieldByLocale[locale] = localizedVersionField\n        }\n      }\n    } else {\n      const baseVersionField = buildVersionField({\n        clientField: clientField as ClientField,\n        clientSchemaMap,\n        customDiffComponents,\n        entitySlug,\n        field,\n        fieldPermissions,\n        i18n,\n        indexPath,\n        modifiedOnly,\n        nestingLevel,\n        parentIsLocalized: parentIsLocalized || ('localized' in field && field.localized),\n        parentPath,\n        parentSchemaPath,\n        path,\n        req,\n        schemaPath,\n        selectedLocales,\n        valueFrom,\n        valueTo,\n      })\n\n      if (baseVersionField) {\n        versionField.field = baseVersionField\n      }\n    }\n\n    if (\n      versionField.field ||\n      (versionField.fieldByLocale && Object.keys(versionField.fieldByLocale).length)\n    ) {\n      versionFields.push(versionField)\n    }\n  }\n\n  return {\n    versionFields,\n  }\n}\n\nconst buildVersionField = ({\n  clientField,\n  clientSchemaMap,\n  customDiffComponents,\n  entitySlug,\n  field,\n  fieldPermissions,\n  i18n,\n  indexPath,\n  locale,\n  modifiedOnly,\n  nestingLevel,\n  parentIsLocalized,\n  parentPath,\n  parentSchemaPath,\n  path,\n  req,\n  schemaPath,\n  selectedLocales,\n  valueFrom,\n  valueTo,\n}: {\n  clientField: ClientField\n  field: Field\n  indexPath: string\n  locale?: string\n  modifiedOnly?: boolean\n  nestingLevel: number\n  parentIsLocalized: boolean\n  path: string\n  schemaPath: string\n  valueFrom: unknown\n  valueTo: unknown\n} & Omit<\n  BuildVersionFieldsArgs,\n  'fields' | 'parentIndexPath' | 'versionFromSiblingData' | 'versionToSiblingData'\n>): BaseVersionField | null => {\n  const fieldName: null | string = 'name' in field ? field.name : null\n\n  const hasPermission =\n    fieldPermissions === true ||\n    !fieldName ||\n    fieldPermissions?.[fieldName] === true ||\n    fieldPermissions?.[fieldName]?.read\n\n  const subFieldPermissions =\n    fieldPermissions === true ||\n    !fieldName ||\n    fieldPermissions?.[fieldName] === true ||\n    fieldPermissions?.[fieldName]?.fields\n\n  if (!hasPermission) {\n    return null\n  }\n\n  if (modifiedOnly && dequal(valueFrom, valueTo)) {\n    return null\n  }\n\n  let CustomComponent = customDiffComponents?.[field.type]\n  if (field?.type === 'richText') {\n    if (!field?.editor) {\n      throw new MissingEditorProp(field) // while we allow disabling editor functionality, you should not have any richText fields defined if you do not have an editor\n    }\n\n    if (typeof field?.editor === 'function') {\n      throw new Error('Attempted to access unsanitized rich text editor.')\n    }\n\n    if (field.editor.CellComponent) {\n      CustomComponent = field.editor.DiffComponent\n    }\n  }\n  if (field?.admin?.components?.Diff) {\n    CustomComponent = field.admin.components.Diff\n  }\n\n  const DefaultComponent = diffComponents?.[field.type]\n\n  const baseVersionField: BaseVersionField = {\n    type: field.type,\n    fields: [],\n    path,\n    schemaPath,\n  }\n\n  if (field.type === 'tabs' && 'tabs' in field) {\n    baseVersionField.tabs = []\n    let tabIndex = -1\n    for (const tab of field.tabs) {\n      tabIndex++\n      const isNamedTab = tabHasName(tab)\n\n      const tabAsField = { ...tab, type: 'tab' }\n\n      const {\n        indexPath: tabIndexPath,\n        path: tabPath,\n        schemaPath: tabSchemaPath,\n      } = getFieldPathsModified({\n        field: tabAsField,\n        index: tabIndex,\n        parentIndexPath: indexPath,\n        parentPath,\n        parentSchemaPath,\n      })\n      const tabVersion = {\n        name: 'name' in tab ? tab.name : null,\n        fields: buildVersionFields({\n          clientSchemaMap,\n          customDiffComponents,\n          entitySlug,\n          fieldPermissions,\n          fields: tab.fields,\n          i18n,\n          modifiedOnly,\n          nestingLevel: nestingLevel + 1,\n          parentIndexPath: isNamedTab ? '' : tabIndexPath,\n          parentIsLocalized: parentIsLocalized || tab.localized,\n          parentPath: isNamedTab ? tabPath : path,\n          parentSchemaPath: isNamedTab ? tabSchemaPath : parentSchemaPath,\n          req,\n          selectedLocales,\n          versionFromSiblingData: 'name' in tab ? valueFrom?.[tab.name] : valueFrom,\n          versionToSiblingData: 'name' in tab ? valueTo?.[tab.name] : valueTo,\n        }).versionFields,\n        label: tab.label,\n      }\n      if (tabVersion?.fields?.length) {\n        baseVersionField.tabs.push(tabVersion)\n      }\n    }\n\n    if (modifiedOnly && !baseVersionField.tabs.length) {\n      return null\n    }\n  } // At this point, we are dealing with a `row`, `collapsible`, etc\n  else if ('fields' in field) {\n    if (field.type === 'array' && (valueTo || valueFrom)) {\n      const maxLength = Math.max(\n        Array.isArray(valueTo) ? valueTo.length : 0,\n        Array.isArray(valueFrom) ? valueFrom.length : 0,\n      )\n      baseVersionField.rows = []\n\n      for (let i = 0; i < maxLength; i++) {\n        const fromRow = (Array.isArray(valueFrom) && valueFrom?.[i]) || {}\n        const toRow = (Array.isArray(valueTo) && valueTo?.[i]) || {}\n\n        baseVersionField.rows[i] = buildVersionFields({\n          clientSchemaMap,\n          customDiffComponents,\n          entitySlug,\n          fieldPermissions,\n          fields: field.fields,\n          i18n,\n          modifiedOnly,\n          nestingLevel: nestingLevel + 1,\n          parentIndexPath: 'name' in field ? '' : indexPath,\n          parentIsLocalized: parentIsLocalized || field.localized,\n          parentPath: path + '.' + i,\n          parentSchemaPath: schemaPath,\n          req,\n          selectedLocales,\n          versionFromSiblingData: fromRow,\n          versionToSiblingData: toRow,\n        }).versionFields\n      }\n\n      if (!baseVersionField.rows?.length && modifiedOnly) {\n        return null\n      }\n    } else {\n      baseVersionField.fields = buildVersionFields({\n        clientSchemaMap,\n        customDiffComponents,\n        entitySlug,\n        fieldPermissions,\n        fields: field.fields,\n        i18n,\n        modifiedOnly,\n        nestingLevel: field.type !== 'row' ? nestingLevel + 1 : nestingLevel,\n        parentIndexPath: 'name' in field ? '' : indexPath,\n        parentIsLocalized: parentIsLocalized || ('localized' in field && field.localized),\n        parentPath: 'name' in field ? path : parentPath,\n        parentSchemaPath: 'name' in field ? schemaPath : parentSchemaPath,\n        req,\n        selectedLocales,\n        versionFromSiblingData: valueFrom as object,\n        versionToSiblingData: valueTo as object,\n      }).versionFields\n\n      if (modifiedOnly && !baseVersionField.fields?.length) {\n        return null\n      }\n    }\n  } else if (field.type === 'blocks') {\n    baseVersionField.rows = []\n\n    const maxLength = Math.max(\n      Array.isArray(valueTo) ? valueTo.length : 0,\n      Array.isArray(valueFrom) ? valueFrom.length : 0,\n    )\n\n    for (let i = 0; i < maxLength; i++) {\n      const fromRow = (Array.isArray(valueFrom) && valueFrom?.[i]) || {}\n      const toRow = (Array.isArray(valueTo) && valueTo?.[i]) || {}\n\n      const blockSlugToMatch: string = toRow?.blockType ?? fromRow?.blockType\n      const toBlock =\n        req.payload.blocks[blockSlugToMatch] ??\n        ((field.blockReferences ?? field.blocks).find(\n          (block) => typeof block !== 'string' && block.slug === blockSlugToMatch,\n        ) as FlattenedBlock | undefined)\n\n      let fields = []\n\n      if (toRow.blockType === fromRow.blockType) {\n        fields = toBlock.fields\n      } else {\n        const fromBlockSlugToMatch: string = toRow?.blockType ?? fromRow?.blockType\n\n        const fromBlock =\n          req.payload.blocks[fromBlockSlugToMatch] ??\n          ((field.blockReferences ?? field.blocks).find(\n            (block) => typeof block !== 'string' && block.slug === fromBlockSlugToMatch,\n          ) as FlattenedBlock | undefined)\n\n        if (fromBlock) {\n          fields = getUniqueListBy<Field>([...toBlock.fields, ...fromBlock.fields], 'name')\n        } else {\n          fields = toBlock.fields\n        }\n      }\n\n      baseVersionField.rows[i] = buildVersionFields({\n        clientSchemaMap,\n        customDiffComponents,\n        entitySlug,\n        fieldPermissions,\n        fields,\n        i18n,\n        modifiedOnly,\n        nestingLevel: nestingLevel + 1,\n        parentIndexPath: 'name' in field ? '' : indexPath,\n        parentIsLocalized: parentIsLocalized || ('localized' in field && field.localized),\n        parentPath: path + '.' + i,\n        parentSchemaPath: schemaPath + '.' + toBlock.slug,\n        req,\n        selectedLocales,\n        versionFromSiblingData: fromRow,\n        versionToSiblingData: toRow,\n      }).versionFields\n    }\n    if (!baseVersionField.rows?.length && modifiedOnly) {\n      return null\n    }\n  }\n\n  const clientDiffProps: FieldDiffClientProps = {\n    baseVersionField: {\n      ...baseVersionField,\n      CustomComponent: undefined,\n    },\n    /**\n     * TODO: Change to valueFrom in 4.0\n     */\n    comparisonValue: valueFrom,\n    /**\n     * @deprecated remove in 4.0. Each field should handle its own diffing logic\n     */\n    diffMethod: 'diffWordsWithSpace',\n    field: clientField,\n    fieldPermissions: subFieldPermissions,\n    parentIsLocalized,\n\n    nestingLevel: nestingLevel ? nestingLevel : undefined,\n    /**\n     * TODO: Change to valueTo in 4.0\n     */\n    versionValue: valueTo,\n  }\n  if (locale) {\n    clientDiffProps.locale = locale\n  }\n\n  const serverDiffProps: FieldDiffServerProps = {\n    ...clientDiffProps,\n    clientField,\n    field,\n    i18n,\n    req,\n    selectedLocales,\n  }\n\n  baseVersionField.CustomComponent = RenderServerComponent({\n    clientProps: clientDiffProps,\n    Component: CustomComponent,\n    Fallback: DefaultComponent,\n    importMap: req.payload.importMap,\n    key: 'diff component',\n    serverProps: serverDiffProps,\n  })\n\n  return baseVersionField\n}\n"],"mappings":"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","ignoreList":[]}