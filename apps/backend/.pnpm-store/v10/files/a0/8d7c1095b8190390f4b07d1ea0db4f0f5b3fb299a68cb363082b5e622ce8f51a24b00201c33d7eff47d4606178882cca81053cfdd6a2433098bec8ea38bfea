{"version":3,"file":"index.js","names":["getTranslation","transformWhereQuery","validateWhereQuery","React","useMemo","useListQuery","useTranslation","Button","Condition","fieldTypes","reduceFields","baseClass","WhereBuilder","props","collectionPluralLabel","fields","renderedFilters","resolvedFilterOptions","i18n","t","reducedFields","handleWhereChange","query","conditions","whereFromSearch","where","or","transformedWhere","console","warn","JSON","stringify","addCondition","useCallback","andIndex","field","orIndex","relation","newConditions","defaultOperator","type","operators","value","and","splice","String","undefined","push","updateCondition","operator","incomingOperator","valueArg","existingCondition","defaults","valueChanged","operatorChanged","Object","keys","newRowCondition","removeCondition","length","_jsxs","className","Fragment","_jsx","label","map","compoundOrKey","Array","isArray","_","condition","fieldName","filterOptions","get","RenderedFilter","buttonStyle","icon","iconPosition","iconStyle","onClick","find","admin","disableListFilter"],"sources":["../../../src/elements/WhereBuilder/index.tsx"],"sourcesContent":["'use client'\nimport type { Operator } from 'payload'\n\nimport { getTranslation } from '@payloadcms/translations'\nimport { transformWhereQuery, validateWhereQuery } from 'payload/shared'\nimport React, { useMemo } from 'react'\n\nimport type { AddCondition, RemoveCondition, UpdateCondition, WhereBuilderProps } from './types.js'\n\nimport { useListQuery } from '../../providers/ListQuery/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { Button } from '../Button/index.js'\nimport { Condition } from './Condition/index.js'\nimport fieldTypes from './field-types.js'\nimport { reduceFields } from './reduceFields.js'\nimport './index.scss'\n\nconst baseClass = 'where-builder'\n\nexport { WhereBuilderProps }\n\n/**\n * The WhereBuilder component is used to render the filter controls for a collection's list view.\n * It is part of the {@link ListControls} component which is used to render the controls (search, filter, where).\n */\nexport const WhereBuilder: React.FC<WhereBuilderProps> = (props) => {\n  const { collectionPluralLabel, fields, renderedFilters, resolvedFilterOptions } = props\n  const { i18n, t } = useTranslation()\n\n  const reducedFields = useMemo(() => reduceFields({ fields, i18n }), [fields, i18n])\n\n  const { handleWhereChange, query } = useListQuery()\n\n  const conditions = useMemo(() => {\n    const whereFromSearch = query.where\n\n    if (whereFromSearch) {\n      if (validateWhereQuery(whereFromSearch)) {\n        return whereFromSearch.or\n      }\n\n      // Transform the where query to be in the right format. This will transform something simple like [text][equals]=example%20post to the right format\n      const transformedWhere = transformWhereQuery(whereFromSearch)\n\n      if (validateWhereQuery(transformedWhere)) {\n        return transformedWhere.or\n      }\n\n      console.warn(`Invalid where query in URL: ${JSON.stringify(whereFromSearch)}`) // eslint-disable-line no-console\n    }\n\n    return []\n  }, [query.where])\n\n  const addCondition: AddCondition = React.useCallback(\n    async ({ andIndex, field, orIndex, relation }) => {\n      const newConditions = [...conditions]\n\n      const defaultOperator = fieldTypes[field.field.type].operators[0].value\n\n      if (relation === 'and') {\n        newConditions[orIndex].and.splice(andIndex, 0, {\n          [String(field.value)]: {\n            [defaultOperator]: undefined,\n          },\n        })\n      } else {\n        newConditions.push({\n          and: [\n            {\n              [String(field.value)]: {\n                [defaultOperator]: undefined,\n              },\n            },\n          ],\n        })\n      }\n\n      await handleWhereChange({ or: newConditions })\n    },\n    [conditions, handleWhereChange],\n  )\n\n  const updateCondition: UpdateCondition = React.useCallback(\n    async ({ andIndex, field, operator: incomingOperator, orIndex, value: valueArg }) => {\n      const existingCondition = conditions[orIndex].and[andIndex]\n\n      const defaults = fieldTypes[field.field.type]\n      const operator = incomingOperator || defaults.operators[0].value\n\n      if (typeof existingCondition === 'object' && field.value) {\n        const value = valueArg ?? existingCondition?.[operator]\n\n        const valueChanged = value !== existingCondition?.[String(field.value)]?.[String(operator)]\n\n        const operatorChanged =\n          operator !== Object.keys(existingCondition?.[String(field.value)] || {})?.[0]\n\n        if (valueChanged || operatorChanged) {\n          const newRowCondition = {\n            [String(field.value)]: { [operator]: value },\n          }\n\n          const newConditions = [...conditions]\n          newConditions[orIndex].and[andIndex] = newRowCondition\n\n          await handleWhereChange({ or: newConditions })\n        }\n      }\n    },\n    [conditions, handleWhereChange],\n  )\n\n  const removeCondition: RemoveCondition = React.useCallback(\n    async ({ andIndex, orIndex }) => {\n      const newConditions = [...conditions]\n      newConditions[orIndex].and.splice(andIndex, 1)\n\n      if (newConditions[orIndex].and.length === 0) {\n        newConditions.splice(orIndex, 1)\n      }\n\n      await handleWhereChange({ or: newConditions })\n    },\n    [conditions, handleWhereChange],\n  )\n\n  return (\n    <div className={baseClass}>\n      {conditions.length > 0 && (\n        <React.Fragment>\n          <div className={`${baseClass}__label`}>\n            {t('general:filterWhere', { label: getTranslation(collectionPluralLabel, i18n) })}\n          </div>\n          <ul className={`${baseClass}__or-filters`}>\n            {conditions.map((or, orIndex) => {\n              const compoundOrKey = `${orIndex}_${Array.isArray(or?.and) ? or.and.length : ''}`\n\n              return (\n                <li key={compoundOrKey}>\n                  {orIndex !== 0 && <div className={`${baseClass}__label`}>{t('general:or')}</div>}\n                  <ul className={`${baseClass}__and-filters`}>\n                    {Array.isArray(or?.and) &&\n                      or.and.map((_, andIndex) => {\n                        const condition = conditions[orIndex].and[andIndex]\n                        const fieldName = Object.keys(condition)[0]\n\n                        const operator =\n                          (Object.keys(condition?.[fieldName] || {})?.[0] as Operator) || undefined\n\n                        const value = condition?.[fieldName]?.[operator] || undefined\n\n                        return (\n                          <li key={andIndex}>\n                            {andIndex !== 0 && (\n                              <div className={`${baseClass}__label`}>{t('general:and')}</div>\n                            )}\n                            <Condition\n                              addCondition={addCondition}\n                              andIndex={andIndex}\n                              fieldName={fieldName}\n                              filterOptions={resolvedFilterOptions?.get(fieldName)}\n                              operator={operator}\n                              orIndex={orIndex}\n                              reducedFields={reducedFields}\n                              removeCondition={removeCondition}\n                              RenderedFilter={renderedFilters?.get(fieldName)}\n                              updateCondition={updateCondition}\n                              value={value}\n                            />\n                          </li>\n                        )\n                      })}\n                  </ul>\n                </li>\n              )\n            })}\n          </ul>\n          <Button\n            buttonStyle=\"icon-label\"\n            className={`${baseClass}__add-or`}\n            icon=\"plus\"\n            iconPosition=\"left\"\n            iconStyle=\"with-border\"\n            onClick={async () => {\n              await addCondition({\n                andIndex: 0,\n                field: reducedFields.find((field) => !field.field.admin?.disableListFilter),\n                orIndex: conditions.length,\n                relation: 'or',\n              })\n            }}\n          >\n            {t('general:or')}\n          </Button>\n        </React.Fragment>\n      )}\n      {conditions.length === 0 && (\n        <div className={`${baseClass}__no-filters`}>\n          <div className={`${baseClass}__label`}>{t('general:noFiltersSet')}</div>\n          <Button\n            buttonStyle=\"icon-label\"\n            className={`${baseClass}__add-first-filter`}\n            icon=\"plus\"\n            iconPosition=\"left\"\n            iconStyle=\"with-border\"\n            onClick={async () => {\n              if (reducedFields.length > 0) {\n                await addCondition({\n                  andIndex: 0,\n                  field: reducedFields.find((field) => !field.field.admin?.disableListFilter),\n                  orIndex: conditions.length,\n                  relation: 'or',\n                })\n              }\n            }}\n          >\n            {t('general:addFilter')}\n          </Button>\n        </div>\n      )}\n    </div>\n  )\n}\n"],"mappings":"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","ignoreList":[]}