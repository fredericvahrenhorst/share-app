{"version":3,"sources":["../src/updateJobs.ts"],"sourcesContent":["import type { MongooseUpdateQueryOptions } from 'mongoose'\nimport type { Job, UpdateJobs, Where } from 'payload'\n\nimport type { MongooseAdapter } from './index.js'\n\nimport { buildQuery } from './queries/buildQuery.js'\nimport { buildSortParam } from './queries/buildSortParam.js'\nimport { getCollection } from './utilities/getEntity.js'\nimport { getSession } from './utilities/getSession.js'\nimport { handleError } from './utilities/handleError.js'\nimport { transform } from './utilities/transform.js'\n\nexport const updateJobs: UpdateJobs = async function updateMany(\n  this: MongooseAdapter,\n  { id, data, limit, req, returning, sort: sortArg, where: whereArg },\n) {\n  if (!(data?.log as object[])?.length) {\n    delete data.log\n  }\n  const where = id ? { id: { equals: id } } : (whereArg as Where)\n\n  const { collectionConfig, Model } = getCollection({\n    adapter: this,\n    collectionSlug: 'payload-jobs',\n  })\n\n  const sort: Record<string, unknown> | undefined = buildSortParam({\n    adapter: this,\n    config: this.payload.config,\n    fields: collectionConfig.flattenedFields,\n    sort: sortArg || collectionConfig.defaultSort,\n    timestamps: true,\n  })\n\n  const options: MongooseUpdateQueryOptions = {\n    lean: true,\n    new: true,\n    session: await getSession(this, req),\n  }\n\n  let query = await buildQuery({\n    adapter: this,\n    collectionSlug: collectionConfig.slug,\n    fields: collectionConfig.flattenedFields,\n    where,\n  })\n\n  transform({ adapter: this, data, fields: collectionConfig.fields, operation: 'write' })\n\n  let result: Job[] = []\n\n  try {\n    if (id) {\n      if (returning === false) {\n        await Model.updateOne(query, data, options)\n        return null\n      } else {\n        const doc = await Model.findOneAndUpdate(query, data, options)\n        result = doc ? [doc] : []\n      }\n    } else {\n      if (typeof limit === 'number' && limit > 0) {\n        const documentsToUpdate = await Model.find(\n          query,\n          {},\n          { ...options, limit, projection: { _id: 1 }, sort },\n        )\n        if (documentsToUpdate.length === 0) {\n          return null\n        }\n\n        query = { _id: { $in: documentsToUpdate.map((doc) => doc._id) } }\n      }\n\n      await Model.updateMany(query, data, options)\n\n      if (returning === false) {\n        return null\n      }\n\n      result = await Model.find(\n        query,\n        {},\n        {\n          ...options,\n          sort,\n        },\n      )\n    }\n  } catch (error) {\n    handleError({ collection: collectionConfig.slug, error, req })\n  }\n\n  transform({\n    adapter: this,\n    data: result,\n    fields: collectionConfig.fields,\n    operation: 'read',\n  })\n\n  return result\n}\n"],"names":["buildQuery","buildSortParam","getCollection","getSession","handleError","transform","updateJobs","updateMany","id","data","limit","req","returning","sort","sortArg","where","whereArg","log","length","equals","collectionConfig","Model","adapter","collectionSlug","config","payload","fields","flattenedFields","defaultSort","timestamps","options","lean","new","session","query","slug","operation","result","updateOne","doc","findOneAndUpdate","documentsToUpdate","find","projection","_id","$in","map","error","collection"],"mappings":"AAKA,SAASA,UAAU,QAAQ,0BAAyB;AACpD,SAASC,cAAc,QAAQ,8BAA6B;AAC5D,SAASC,aAAa,QAAQ,2BAA0B;AACxD,SAASC,UAAU,QAAQ,4BAA2B;AACtD,SAASC,WAAW,QAAQ,6BAA4B;AACxD,SAASC,SAAS,QAAQ,2BAA0B;AAEpD,OAAO,MAAMC,aAAyB,eAAeC,WAEnD,EAAEC,EAAE,EAAEC,IAAI,EAAEC,KAAK,EAAEC,GAAG,EAAEC,SAAS,EAAEC,MAAMC,OAAO,EAAEC,OAAOC,QAAQ,EAAE;IAEnE,IAAI,CAAEP,MAAMQ,KAAkBC,QAAQ;QACpC,OAAOT,KAAKQ,GAAG;IACjB;IACA,MAAMF,QAAQP,KAAK;QAAEA,IAAI;YAAEW,QAAQX;QAAG;IAAE,IAAKQ;IAE7C,MAAM,EAAEI,gBAAgB,EAAEC,KAAK,EAAE,GAAGnB,cAAc;QAChDoB,SAAS,IAAI;QACbC,gBAAgB;IAClB;IAEA,MAAMV,OAA4CZ,eAAe;QAC/DqB,SAAS,IAAI;QACbE,QAAQ,IAAI,CAACC,OAAO,CAACD,MAAM;QAC3BE,QAAQN,iBAAiBO,eAAe;QACxCd,MAAMC,WAAWM,iBAAiBQ,WAAW;QAC7CC,YAAY;IACd;IAEA,MAAMC,UAAsC;QAC1CC,MAAM;QACNC,KAAK;QACLC,SAAS,MAAM9B,WAAW,IAAI,EAAEQ;IAClC;IAEA,IAAIuB,QAAQ,MAAMlC,WAAW;QAC3BsB,SAAS,IAAI;QACbC,gBAAgBH,iBAAiBe,IAAI;QACrCT,QAAQN,iBAAiBO,eAAe;QACxCZ;IACF;IAEAV,UAAU;QAAEiB,SAAS,IAAI;QAAEb;QAAMiB,QAAQN,iBAAiBM,MAAM;QAAEU,WAAW;IAAQ;IAErF,IAAIC,SAAgB,EAAE;IAEtB,IAAI;QACF,IAAI7B,IAAI;YACN,IAAII,cAAc,OAAO;gBACvB,MAAMS,MAAMiB,SAAS,CAACJ,OAAOzB,MAAMqB;gBACnC,OAAO;YACT,OAAO;gBACL,MAAMS,MAAM,MAAMlB,MAAMmB,gBAAgB,CAACN,OAAOzB,MAAMqB;gBACtDO,SAASE,MAAM;oBAACA;iBAAI,GAAG,EAAE;YAC3B;QACF,OAAO;YACL,IAAI,OAAO7B,UAAU,YAAYA,QAAQ,GAAG;gBAC1C,MAAM+B,oBAAoB,MAAMpB,MAAMqB,IAAI,CACxCR,OACA,CAAC,GACD;oBAAE,GAAGJ,OAAO;oBAAEpB;oBAAOiC,YAAY;wBAAEC,KAAK;oBAAE;oBAAG/B;gBAAK;gBAEpD,IAAI4B,kBAAkBvB,MAAM,KAAK,GAAG;oBAClC,OAAO;gBACT;gBAEAgB,QAAQ;oBAAEU,KAAK;wBAAEC,KAAKJ,kBAAkBK,GAAG,CAAC,CAACP,MAAQA,IAAIK,GAAG;oBAAE;gBAAE;YAClE;YAEA,MAAMvB,MAAMd,UAAU,CAAC2B,OAAOzB,MAAMqB;YAEpC,IAAIlB,cAAc,OAAO;gBACvB,OAAO;YACT;YAEAyB,SAAS,MAAMhB,MAAMqB,IAAI,CACvBR,OACA,CAAC,GACD;gBACE,GAAGJ,OAAO;gBACVjB;YACF;QAEJ;IACF,EAAE,OAAOkC,OAAO;QACd3C,YAAY;YAAE4C,YAAY5B,iBAAiBe,IAAI;YAAEY;YAAOpC;QAAI;IAC9D;IAEAN,UAAU;QACRiB,SAAS,IAAI;QACbb,MAAM4B;QACNX,QAAQN,iBAAiBM,MAAM;QAC/BU,WAAW;IACb;IAEA,OAAOC;AACT,EAAC"}