{"version":3,"sources":["../../src/hooks/uploadCache.ts"],"sourcesContent":["import type { CollectionAfterChangeHook, CollectionAfterDeleteHook, PayloadRequest } from 'payload'\n\ninterface Args {\n  endpoint: string\n}\n\nexport const getCacheUploadsAfterChangeHook =\n  ({ endpoint }: Args): CollectionAfterChangeHook =>\n  ({ doc, operation, req }) => {\n    if (!req || !process.env.PAYLOAD_CLOUD_CACHE_KEY) {\n      return doc\n    }\n\n    // WARNING:\n    // TODO: Test this for 3.0\n    const { payloadAPI } = req\n    if (payloadAPI !== 'local') {\n      if (operation === 'update') {\n        // Unawaited promise\n        void purge({ doc, endpoint, operation, req })\n      }\n    }\n    return doc\n  }\n\nexport const getCacheUploadsAfterDeleteHook =\n  ({ endpoint }: Args): CollectionAfterDeleteHook =>\n  ({ doc, req }) => {\n    if (!req || !process.env.PAYLOAD_CLOUD_CACHE_KEY) {\n      return doc\n    }\n\n    const { payloadAPI } = req\n\n    // WARNING:\n    // TODO: Test this for 3.0\n    if (payloadAPI !== 'local') {\n      // Unawaited promise\n      void purge({ doc, endpoint, operation: 'delete', req })\n    }\n    return doc\n  }\n\ntype PurgeRequest = {\n  doc: any\n  endpoint: string\n  operation: string\n  req: PayloadRequest\n}\n\nasync function purge({ doc, endpoint, operation, req }: PurgeRequest) {\n  const filePath = doc.url\n\n  if (!filePath) {\n    req.payload.logger.error({\n      msg: 'No url found on doc',\n      project: {\n        id: process.env.PAYLOAD_CLOUD_PROJECT_ID,\n      },\n    })\n    return\n  }\n\n  const body = {\n    cacheKey: process.env.PAYLOAD_CLOUD_CACHE_KEY,\n    filepath: doc.url,\n    projectID: process.env.PAYLOAD_CLOUD_PROJECT_ID,\n  }\n  req.payload.logger.debug({\n    filepath: doc.url,\n    msg: 'Attempting to purge cache',\n    operation,\n    project: {\n      id: process.env.PAYLOAD_CLOUD_PROJECT_ID,\n    },\n  })\n\n  try {\n    const purgeRes = await fetch(`${endpoint}/api/purge-cache`, {\n      body: JSON.stringify({\n        ...body,\n      }),\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      method: 'POST',\n    })\n\n    req.payload.logger.debug({\n      msg: 'Purge cache result',\n      operation,\n      statusCode: purgeRes.status,\n    })\n  } catch (err: unknown) {\n    req.payload.logger.error({ body, err, msg: '/purge-cache call failed' })\n  }\n}\n"],"names":["getCacheUploadsAfterChangeHook","endpoint","doc","operation","req","process","env","PAYLOAD_CLOUD_CACHE_KEY","payloadAPI","purge","getCacheUploadsAfterDeleteHook","filePath","url","payload","logger","error","msg","project","id","PAYLOAD_CLOUD_PROJECT_ID","body","cacheKey","filepath","projectID","debug","purgeRes","fetch","JSON","stringify","headers","method","statusCode","status","err"],"mappings":"AAMA,OAAO,MAAMA,iCACX,CAAC,EAAEC,QAAQ,EAAQ,GACnB,CAAC,EAAEC,GAAG,EAAEC,SAAS,EAAEC,GAAG,EAAE;QACtB,IAAI,CAACA,OAAO,CAACC,QAAQC,GAAG,CAACC,uBAAuB,EAAE;YAChD,OAAOL;QACT;QAEA,WAAW;QACX,0BAA0B;QAC1B,MAAM,EAAEM,UAAU,EAAE,GAAGJ;QACvB,IAAII,eAAe,SAAS;YAC1B,IAAIL,cAAc,UAAU;gBAC1B,oBAAoB;gBACpB,KAAKM,MAAM;oBAAEP;oBAAKD;oBAAUE;oBAAWC;gBAAI;YAC7C;QACF;QACA,OAAOF;IACT,EAAC;AAEH,OAAO,MAAMQ,iCACX,CAAC,EAAET,QAAQ,EAAQ,GACnB,CAAC,EAAEC,GAAG,EAAEE,GAAG,EAAE;QACX,IAAI,CAACA,OAAO,CAACC,QAAQC,GAAG,CAACC,uBAAuB,EAAE;YAChD,OAAOL;QACT;QAEA,MAAM,EAAEM,UAAU,EAAE,GAAGJ;QAEvB,WAAW;QACX,0BAA0B;QAC1B,IAAII,eAAe,SAAS;YAC1B,oBAAoB;YACpB,KAAKC,MAAM;gBAAEP;gBAAKD;gBAAUE,WAAW;gBAAUC;YAAI;QACvD;QACA,OAAOF;IACT,EAAC;AASH,eAAeO,MAAM,EAAEP,GAAG,EAAED,QAAQ,EAAEE,SAAS,EAAEC,GAAG,EAAgB;IAClE,MAAMO,WAAWT,IAAIU,GAAG;IAExB,IAAI,CAACD,UAAU;QACbP,IAAIS,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC;YACvBC,KAAK;YACLC,SAAS;gBACPC,IAAIb,QAAQC,GAAG,CAACa,wBAAwB;YAC1C;QACF;QACA;IACF;IAEA,MAAMC,OAAO;QACXC,UAAUhB,QAAQC,GAAG,CAACC,uBAAuB;QAC7Ce,UAAUpB,IAAIU,GAAG;QACjBW,WAAWlB,QAAQC,GAAG,CAACa,wBAAwB;IACjD;IACAf,IAAIS,OAAO,CAACC,MAAM,CAACU,KAAK,CAAC;QACvBF,UAAUpB,IAAIU,GAAG;QACjBI,KAAK;QACLb;QACAc,SAAS;YACPC,IAAIb,QAAQC,GAAG,CAACa,wBAAwB;QAC1C;IACF;IAEA,IAAI;QACF,MAAMM,WAAW,MAAMC,MAAM,GAAGzB,SAAS,gBAAgB,CAAC,EAAE;YAC1DmB,MAAMO,KAAKC,SAAS,CAAC;gBACnB,GAAGR,IAAI;YACT;YACAS,SAAS;gBACP,gBAAgB;YAClB;YACAC,QAAQ;QACV;QAEA1B,IAAIS,OAAO,CAACC,MAAM,CAACU,KAAK,CAAC;YACvBR,KAAK;YACLb;YACA4B,YAAYN,SAASO,MAAM;QAC7B;IACF,EAAE,OAAOC,KAAc;QACrB7B,IAAIS,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC;YAAEK;YAAMa;YAAKjB,KAAK;QAA2B;IACxE;AACF"}