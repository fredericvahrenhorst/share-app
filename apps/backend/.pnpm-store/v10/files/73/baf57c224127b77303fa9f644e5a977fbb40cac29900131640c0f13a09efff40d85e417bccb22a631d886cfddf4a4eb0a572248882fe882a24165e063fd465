{"version":3,"file":"DrawerContent.js","names":["Form","FormSubmit","RenderFields","useDocumentForm","useDocumentInfo","useServerFunctions","useTranslation","abortAndIgnore","deepCopyObjectSimpleWithoutReactComponents","React","useCallback","useEffect","useRef","useState","v4","uuid","useEditorConfigContext","DrawerContent","data","featureKey","fieldMapOverride","handleDrawerSubmit","schemaFieldsPathOverride","schemaPath","schemaPathSuffix","t","id","collectionSlug","getDocPreferences","globalSlug","fields","parentDocumentFields","onChangeAbortControllerRef","AbortController","initialState","setInitialState","fieldProps","featureClientSchemaMap","getFormState","schemaFieldsPath","controller","awaitInitialState","state","docPermissions","docPreferences","documentFormState","initialBlockData","operation","renderAllFields","signal","onChange","formState","prevFormState","current","initialBlockFormState","_jsxs","beforeSubmit","disableValidationOnSubmit","Array","isArray","onSubmit","_jsx","forceRender","parentIndexPath","parentPath","parentSchemaPath","permissions","readOnly"],"sources":["../../../src/utilities/fieldsDrawer/DrawerContent.tsx"],"sourcesContent":["'use client'\nimport type { FormState } from 'payload'\n\nimport {\n  Form,\n  FormSubmit,\n  RenderFields,\n  useDocumentForm,\n  useDocumentInfo,\n  useServerFunctions,\n  useTranslation,\n} from '@payloadcms/ui'\nimport { abortAndIgnore } from '@payloadcms/ui/shared'\nimport { deepCopyObjectSimpleWithoutReactComponents } from 'payload/shared'\nimport React, { useCallback, useEffect, useRef, useState } from 'react'\nimport { v4 as uuid } from 'uuid'\n\nimport type { FieldsDrawerProps } from './Drawer.js'\n\nimport { useEditorConfigContext } from '../../lexical/config/client/EditorConfigProvider.js'\n\nexport const DrawerContent: React.FC<Omit<FieldsDrawerProps, 'drawerSlug' | 'drawerTitle'>> = ({\n  data,\n  featureKey,\n  fieldMapOverride,\n  handleDrawerSubmit,\n  schemaFieldsPathOverride,\n  schemaPath,\n  schemaPathSuffix,\n}) => {\n  const { t } = useTranslation()\n  const { id, collectionSlug, getDocPreferences, globalSlug } = useDocumentInfo()\n  const { fields: parentDocumentFields } = useDocumentForm()\n\n  const onChangeAbortControllerRef = useRef(new AbortController())\n\n  const [initialState, setInitialState] = useState<false | FormState | undefined>(false)\n\n  const {\n    fieldProps: { featureClientSchemaMap },\n  } = useEditorConfigContext()\n\n  const { getFormState } = useServerFunctions()\n\n  const schemaFieldsPath =\n    schemaFieldsPathOverride ??\n    `${schemaPath}.lexical_internal_feature.${featureKey}${schemaPathSuffix ? `.${schemaPathSuffix}` : ''}`\n\n  const fields: any = fieldMapOverride ?? featureClientSchemaMap[featureKey]?.[schemaFieldsPath] // Field Schema\n\n  useEffect(() => {\n    const controller = new AbortController()\n\n    const awaitInitialState = async () => {\n      const { state } = await getFormState({\n        id,\n        collectionSlug,\n        data: data ?? {},\n        docPermissions: {\n          fields: true,\n        },\n        docPreferences: await getDocPreferences(),\n        documentFormState: deepCopyObjectSimpleWithoutReactComponents(parentDocumentFields),\n        globalSlug,\n        initialBlockData: data,\n        operation: 'update',\n        renderAllFields: true,\n        schemaPath: schemaFieldsPath,\n        signal: controller.signal,\n      })\n\n      setInitialState(state)\n    }\n\n    void awaitInitialState()\n\n    return () => {\n      abortAndIgnore(controller)\n    }\n  }, [\n    schemaFieldsPath,\n    id,\n    data,\n    getFormState,\n    collectionSlug,\n    globalSlug,\n    getDocPreferences,\n    parentDocumentFields,\n  ])\n\n  const onChange = useCallback(\n    async ({ formState: prevFormState }: { formState: FormState }) => {\n      abortAndIgnore(onChangeAbortControllerRef.current)\n\n      const controller = new AbortController()\n      onChangeAbortControllerRef.current = controller\n\n      const { state } = await getFormState({\n        id,\n        collectionSlug,\n        docPermissions: {\n          fields: true,\n        },\n        docPreferences: await getDocPreferences(),\n        documentFormState: deepCopyObjectSimpleWithoutReactComponents(parentDocumentFields),\n        formState: prevFormState,\n        globalSlug,\n        initialBlockFormState: prevFormState,\n        operation: 'update',\n        schemaPath: schemaFieldsPath,\n        signal: controller.signal,\n      })\n\n      if (!state) {\n        return prevFormState\n      }\n\n      return state\n    },\n    [\n      getFormState,\n      id,\n      collectionSlug,\n      getDocPreferences,\n      parentDocumentFields,\n      globalSlug,\n      schemaFieldsPath,\n    ],\n  )\n\n  // cleanup effect\n  useEffect(() => {\n    return () => {\n      abortAndIgnore(onChangeAbortControllerRef.current)\n    }\n  }, [])\n\n  if (initialState === false) {\n    return null\n  }\n\n  return (\n    <Form\n      beforeSubmit={[onChange]}\n      disableValidationOnSubmit\n      fields={Array.isArray(fields) ? fields : []}\n      initialState={initialState}\n      onChange={[onChange]}\n      onSubmit={handleDrawerSubmit}\n      uuid={uuid()}\n    >\n      <RenderFields\n        fields={Array.isArray(fields) ? fields : []}\n        forceRender\n        parentIndexPath=\"\"\n        parentPath=\"\" // See Blocks feature path for details as for why this is empty\n        parentSchemaPath={schemaFieldsPath}\n        permissions={true}\n        readOnly={false}\n      />\n      <FormSubmit>{t('fields:saveChanges')}</FormSubmit>\n    </Form>\n  )\n}\n"],"mappings":"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","ignoreList":[]}