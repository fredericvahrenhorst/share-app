{"version":3,"sources":["../src/connect.ts"],"sourcesContent":["import type { ConnectOptions } from 'mongoose'\nimport type { Connect } from 'payload'\n\nimport mongoose from 'mongoose'\nimport { defaultBeginTransaction } from 'payload'\n\nimport type { MongooseAdapter } from './index.js'\n\nexport const connect: Connect = async function connect(\n  this: MongooseAdapter,\n  options = {\n    hotReload: false,\n  },\n) {\n  const { hotReload } = options\n\n  if (this.url === false) {\n    return\n  }\n\n  if (typeof this.url !== 'string') {\n    throw new Error('Error: missing MongoDB connection URL.')\n  }\n\n  const urlToConnect = this.url\n\n  const connectionOptions: { useFacet: undefined } & ConnectOptions = {\n    autoIndex: true,\n    ...this.connectOptions,\n    useFacet: undefined,\n  }\n\n  if (hotReload) {\n    connectionOptions.autoIndex = false\n  }\n\n  try {\n    this.connection = (await mongoose.connect(urlToConnect, connectionOptions)).connection\n\n    // If we are running a replica set with MongoDB Memory Server,\n    // wait until the replica set elects a primary before proceeding\n    if (this.mongoMemoryServer) {\n      this.payload.logger.info(\n        'Waiting for MongoDB Memory Server replica set to elect a primary...',\n      )\n      await new Promise((resolve) => setTimeout(resolve, 2000))\n    }\n\n    const client = this.connection.getClient()\n\n    if (!client.options.replicaSet) {\n      this.transactionOptions = false\n      this.beginTransaction = defaultBeginTransaction()\n    }\n\n    if (!hotReload) {\n      if (process.env.PAYLOAD_DROP_DATABASE === 'true') {\n        this.payload.logger.info('---- DROPPING DATABASE ----')\n        await mongoose.connection.dropDatabase()\n        this.payload.logger.info('---- DROPPED DATABASE ----')\n      }\n    }\n\n    if (this.ensureIndexes) {\n      await Promise.all(\n        this.payload.config.collections.map(async (coll) => {\n          await this.collections[coll.slug]?.ensureIndexes()\n        }),\n      )\n    }\n\n    if (process.env.NODE_ENV === 'production' && this.prodMigrations) {\n      await this.migrate({ migrations: this.prodMigrations })\n    }\n  } catch (err) {\n    let msg = `Error: cannot connect to MongoDB.`\n\n    if (typeof err === 'object' && err && 'message' in err && typeof err.message === 'string') {\n      msg = `${msg} Details: ${err.message}`\n    }\n\n    this.payload.logger.error({\n      err,\n      msg,\n    })\n    process.exit(1)\n  }\n}\n"],"names":["mongoose","defaultBeginTransaction","connect","options","hotReload","url","Error","urlToConnect","connectionOptions","autoIndex","connectOptions","useFacet","undefined","connection","mongoMemoryServer","payload","logger","info","Promise","resolve","setTimeout","client","getClient","replicaSet","transactionOptions","beginTransaction","process","env","PAYLOAD_DROP_DATABASE","dropDatabase","ensureIndexes","all","config","collections","map","coll","slug","NODE_ENV","prodMigrations","migrate","migrations","err","msg","message","error","exit"],"mappings":"AAGA,OAAOA,cAAc,WAAU;AAC/B,SAASC,uBAAuB,QAAQ,UAAS;AAIjD,OAAO,MAAMC,UAAmB,eAAeA,QAE7CC,UAAU;IACRC,WAAW;AACb,CAAC;IAED,MAAM,EAAEA,SAAS,EAAE,GAAGD;IAEtB,IAAI,IAAI,CAACE,GAAG,KAAK,OAAO;QACtB;IACF;IAEA,IAAI,OAAO,IAAI,CAACA,GAAG,KAAK,UAAU;QAChC,MAAM,IAAIC,MAAM;IAClB;IAEA,MAAMC,eAAe,IAAI,CAACF,GAAG;IAE7B,MAAMG,oBAA8D;QAClEC,WAAW;QACX,GAAG,IAAI,CAACC,cAAc;QACtBC,UAAUC;IACZ;IAEA,IAAIR,WAAW;QACbI,kBAAkBC,SAAS,GAAG;IAChC;IAEA,IAAI;QACF,IAAI,CAACI,UAAU,GAAG,AAAC,CAAA,MAAMb,SAASE,OAAO,CAACK,cAAcC,kBAAiB,EAAGK,UAAU;QAEtF,8DAA8D;QAC9D,gEAAgE;QAChE,IAAI,IAAI,CAACC,iBAAiB,EAAE;YAC1B,IAAI,CAACC,OAAO,CAACC,MAAM,CAACC,IAAI,CACtB;YAEF,MAAM,IAAIC,QAAQ,CAACC,UAAYC,WAAWD,SAAS;QACrD;QAEA,MAAME,SAAS,IAAI,CAACR,UAAU,CAACS,SAAS;QAExC,IAAI,CAACD,OAAOlB,OAAO,CAACoB,UAAU,EAAE;YAC9B,IAAI,CAACC,kBAAkB,GAAG;YAC1B,IAAI,CAACC,gBAAgB,GAAGxB;QAC1B;QAEA,IAAI,CAACG,WAAW;YACd,IAAIsB,QAAQC,GAAG,CAACC,qBAAqB,KAAK,QAAQ;gBAChD,IAAI,CAACb,OAAO,CAACC,MAAM,CAACC,IAAI,CAAC;gBACzB,MAAMjB,SAASa,UAAU,CAACgB,YAAY;gBACtC,IAAI,CAACd,OAAO,CAACC,MAAM,CAACC,IAAI,CAAC;YAC3B;QACF;QAEA,IAAI,IAAI,CAACa,aAAa,EAAE;YACtB,MAAMZ,QAAQa,GAAG,CACf,IAAI,CAAChB,OAAO,CAACiB,MAAM,CAACC,WAAW,CAACC,GAAG,CAAC,OAAOC;gBACzC,MAAM,IAAI,CAACF,WAAW,CAACE,KAAKC,IAAI,CAAC,EAAEN;YACrC;QAEJ;QAEA,IAAIJ,QAAQC,GAAG,CAACU,QAAQ,KAAK,gBAAgB,IAAI,CAACC,cAAc,EAAE;YAChE,MAAM,IAAI,CAACC,OAAO,CAAC;gBAAEC,YAAY,IAAI,CAACF,cAAc;YAAC;QACvD;IACF,EAAE,OAAOG,KAAK;QACZ,IAAIC,MAAM,CAAC,iCAAiC,CAAC;QAE7C,IAAI,OAAOD,QAAQ,YAAYA,OAAO,aAAaA,OAAO,OAAOA,IAAIE,OAAO,KAAK,UAAU;YACzFD,MAAM,GAAGA,IAAI,UAAU,EAAED,IAAIE,OAAO,EAAE;QACxC;QAEA,IAAI,CAAC5B,OAAO,CAACC,MAAM,CAAC4B,KAAK,CAAC;YACxBH;YACAC;QACF;QACAhB,QAAQmB,IAAI,CAAC;IACf;AACF,EAAC"}