{"version":3,"sources":["../../src/hooks/afterDelete.ts"],"sourcesContent":["import type { CollectionAfterDeleteHook, CollectionConfig, FileData, TypeWithID } from 'payload'\n\nimport type { TypeWithPrefix } from '../types.js'\n\nimport { createKey } from '../utilities/createKey.js'\nimport { getStorageClient } from '../utilities/getStorageClient.js'\n\ninterface Args {\n  collection: CollectionConfig\n}\n\nexport const getAfterDeleteHook = ({\n  collection,\n}: Args): CollectionAfterDeleteHook<FileData & TypeWithID & TypeWithPrefix> => {\n  return async ({ doc, req }) => {\n    try {\n      const { identityID, storageClient } = await getStorageClient()\n\n      const filesToDelete: string[] = [\n        doc.filename || '',\n        ...Object.values(doc?.sizes || [])\n          .map((resizedFileData) => resizedFileData.filename)\n          .filter((filename): filename is string => filename !== null),\n      ]\n\n      const promises = filesToDelete.map(async (filename) => {\n        await storageClient.deleteObject({\n          Bucket: process.env.PAYLOAD_CLOUD_BUCKET,\n          Key: createKey({ collection: collection.slug, filename, identityID }),\n        })\n      })\n\n      await Promise.all(promises)\n    } catch (err: unknown) {\n      req.payload.logger.error(\n        `There was an error while deleting files corresponding to the ${collection.labels?.singular} with ID ${doc.id}:`,\n      )\n      req.payload.logger.error(err)\n    }\n    return doc\n  }\n}\n"],"names":["createKey","getStorageClient","getAfterDeleteHook","collection","doc","req","identityID","storageClient","filesToDelete","filename","Object","values","sizes","map","resizedFileData","filter","promises","deleteObject","Bucket","process","env","PAYLOAD_CLOUD_BUCKET","Key","slug","Promise","all","err","payload","logger","error","labels","singular","id"],"mappings":"AAIA,SAASA,SAAS,QAAQ,4BAA2B;AACrD,SAASC,gBAAgB,QAAQ,mCAAkC;AAMnE,OAAO,MAAMC,qBAAqB,CAAC,EACjCC,UAAU,EACL;IACL,OAAO,OAAO,EAAEC,GAAG,EAAEC,GAAG,EAAE;QACxB,IAAI;YACF,MAAM,EAAEC,UAAU,EAAEC,aAAa,EAAE,GAAG,MAAMN;YAE5C,MAAMO,gBAA0B;gBAC9BJ,IAAIK,QAAQ,IAAI;mBACbC,OAAOC,MAAM,CAACP,KAAKQ,SAAS,EAAE,EAC9BC,GAAG,CAAC,CAACC,kBAAoBA,gBAAgBL,QAAQ,EACjDM,MAAM,CAAC,CAACN,WAAiCA,aAAa;aAC1D;YAED,MAAMO,WAAWR,cAAcK,GAAG,CAAC,OAAOJ;gBACxC,MAAMF,cAAcU,YAAY,CAAC;oBAC/BC,QAAQC,QAAQC,GAAG,CAACC,oBAAoB;oBACxCC,KAAKtB,UAAU;wBAAEG,YAAYA,WAAWoB,IAAI;wBAAEd;wBAAUH;oBAAW;gBACrE;YACF;YAEA,MAAMkB,QAAQC,GAAG,CAACT;QACpB,EAAE,OAAOU,KAAc;YACrBrB,IAAIsB,OAAO,CAACC,MAAM,CAACC,KAAK,CACtB,CAAC,6DAA6D,EAAE1B,WAAW2B,MAAM,EAAEC,SAAS,SAAS,EAAE3B,IAAI4B,EAAE,CAAC,CAAC,CAAC;YAElH3B,IAAIsB,OAAO,CAACC,MAAM,CAACC,KAAK,CAACH;QAC3B;QACA,OAAOtB;IACT;AACF,EAAC"}