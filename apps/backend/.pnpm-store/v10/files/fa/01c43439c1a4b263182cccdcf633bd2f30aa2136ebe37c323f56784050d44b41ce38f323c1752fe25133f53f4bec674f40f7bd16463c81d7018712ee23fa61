{"version":3,"sources":["../../src/utilities/refreshSession.ts"],"sourcesContent":["import { CognitoIdentityClient } from '@aws-sdk/client-cognito-identity'\nimport { S3 } from '@aws-sdk/client-s3'\nimport { fromCognitoIdentityPool } from '@aws-sdk/credential-providers'\n\nimport { authAsCognitoUser } from './authAsCognitoUser.js'\n\nexport type GetStorageClient = () => Promise<{\n  identityID: string\n  storageClient: S3\n}>\n\nexport const refreshSession = async () => {\n  const session = await authAsCognitoUser(\n    process.env.PAYLOAD_CLOUD_PROJECT_ID || '',\n    process.env.PAYLOAD_CLOUD_COGNITO_PASSWORD || '',\n  )\n\n  const cognitoIdentity = new CognitoIdentityClient({\n    credentials: fromCognitoIdentityPool({\n      clientConfig: {\n        region: 'us-east-1',\n      },\n      identityPoolId: process.env.PAYLOAD_CLOUD_COGNITO_IDENTITY_POOL_ID || '',\n      logins: {\n        [`cognito-idp.us-east-1.amazonaws.com/${process.env.PAYLOAD_CLOUD_COGNITO_USER_POOL_ID}`]:\n          session.getIdToken().getJwtToken(),\n      },\n    }),\n  })\n\n  const credentials = await cognitoIdentity.config.credentials()\n\n  // @ts-expect-error - Incorrect AWS types\n  const identityID = credentials.identityId\n\n  const storageClient = new S3({\n    credentials,\n    region: process.env.PAYLOAD_CLOUD_BUCKET_REGION,\n  })\n\n  return {\n    identityID,\n    session,\n    storageClient,\n  }\n}\n"],"names":["CognitoIdentityClient","S3","fromCognitoIdentityPool","authAsCognitoUser","refreshSession","session","process","env","PAYLOAD_CLOUD_PROJECT_ID","PAYLOAD_CLOUD_COGNITO_PASSWORD","cognitoIdentity","credentials","clientConfig","region","identityPoolId","PAYLOAD_CLOUD_COGNITO_IDENTITY_POOL_ID","logins","PAYLOAD_CLOUD_COGNITO_USER_POOL_ID","getIdToken","getJwtToken","config","identityID","identityId","storageClient","PAYLOAD_CLOUD_BUCKET_REGION"],"mappings":"AAAA,SAASA,qBAAqB,QAAQ,mCAAkC;AACxE,SAASC,EAAE,QAAQ,qBAAoB;AACvC,SAASC,uBAAuB,QAAQ,gCAA+B;AAEvE,SAASC,iBAAiB,QAAQ,yBAAwB;AAO1D,OAAO,MAAMC,iBAAiB;IAC5B,MAAMC,UAAU,MAAMF,kBACpBG,QAAQC,GAAG,CAACC,wBAAwB,IAAI,IACxCF,QAAQC,GAAG,CAACE,8BAA8B,IAAI;IAGhD,MAAMC,kBAAkB,IAAIV,sBAAsB;QAChDW,aAAaT,wBAAwB;YACnCU,cAAc;gBACZC,QAAQ;YACV;YACAC,gBAAgBR,QAAQC,GAAG,CAACQ,sCAAsC,IAAI;YACtEC,QAAQ;gBACN,CAAC,CAAC,oCAAoC,EAAEV,QAAQC,GAAG,CAACU,kCAAkC,EAAE,CAAC,EACvFZ,QAAQa,UAAU,GAAGC,WAAW;YACpC;QACF;IACF;IAEA,MAAMR,cAAc,MAAMD,gBAAgBU,MAAM,CAACT,WAAW;IAE5D,yCAAyC;IACzC,MAAMU,aAAaV,YAAYW,UAAU;IAEzC,MAAMC,gBAAgB,IAAItB,GAAG;QAC3BU;QACAE,QAAQP,QAAQC,GAAG,CAACiB,2BAA2B;IACjD;IAEA,OAAO;QACLH;QACAhB;QACAkB;IACF;AACF,EAAC"}