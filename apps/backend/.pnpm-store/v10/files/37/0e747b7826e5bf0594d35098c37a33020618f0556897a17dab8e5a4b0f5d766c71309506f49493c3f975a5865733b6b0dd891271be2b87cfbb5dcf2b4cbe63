{"version":3,"sources":["../../src/models/buildCollectionSchema.ts"],"sourcesContent":["import type { PaginateOptions, Schema } from 'mongoose'\nimport type { Payload, SanitizedCollectionConfig } from 'payload'\n\nimport paginate from 'mongoose-paginate-v2'\n\nimport { getBuildQueryPlugin } from '../queries/getBuildQueryPlugin.js'\nimport { buildSchema } from './buildSchema.js'\n\nexport const buildCollectionSchema = (\n  collection: SanitizedCollectionConfig,\n  payload: Payload,\n  schemaOptions = {},\n): Schema => {\n  const schema = buildSchema({\n    buildSchemaOptions: {\n      draftsEnabled: Boolean(\n        typeof collection?.versions === 'object' && collection.versions.drafts,\n      ),\n      indexSortableFields: payload.config.indexSortableFields,\n      options: {\n        minimize: false,\n        timestamps: collection.timestamps !== false,\n        ...schemaOptions,\n      },\n    },\n    compoundIndexes: collection.sanitizedIndexes,\n    configFields: collection.fields,\n    payload,\n  })\n\n  if (Array.isArray(collection.upload.filenameCompoundIndex)) {\n    const indexDefinition = collection.upload.filenameCompoundIndex.reduce<Record<string, 1>>(\n      (acc, index) => {\n        acc[index] = 1\n        return acc\n      },\n      {},\n    )\n\n    schema.index(indexDefinition, { unique: true })\n  }\n\n  schema\n    .plugin<any, PaginateOptions>(paginate, { useEstimatedCount: true })\n    .plugin(getBuildQueryPlugin({ collectionSlug: collection.slug }))\n\n  return schema\n}\n"],"names":["paginate","getBuildQueryPlugin","buildSchema","buildCollectionSchema","collection","payload","schemaOptions","schema","buildSchemaOptions","draftsEnabled","Boolean","versions","drafts","indexSortableFields","config","options","minimize","timestamps","compoundIndexes","sanitizedIndexes","configFields","fields","Array","isArray","upload","filenameCompoundIndex","indexDefinition","reduce","acc","index","unique","plugin","useEstimatedCount","collectionSlug","slug"],"mappings":"AAGA,OAAOA,cAAc,uBAAsB;AAE3C,SAASC,mBAAmB,QAAQ,oCAAmC;AACvE,SAASC,WAAW,QAAQ,mBAAkB;AAE9C,OAAO,MAAMC,wBAAwB,CACnCC,YACAC,SACAC,gBAAgB,CAAC,CAAC;IAElB,MAAMC,SAASL,YAAY;QACzBM,oBAAoB;YAClBC,eAAeC,QACb,OAAON,YAAYO,aAAa,YAAYP,WAAWO,QAAQ,CAACC,MAAM;YAExEC,qBAAqBR,QAAQS,MAAM,CAACD,mBAAmB;YACvDE,SAAS;gBACPC,UAAU;gBACVC,YAAYb,WAAWa,UAAU,KAAK;gBACtC,GAAGX,aAAa;YAClB;QACF;QACAY,iBAAiBd,WAAWe,gBAAgB;QAC5CC,cAAchB,WAAWiB,MAAM;QAC/BhB;IACF;IAEA,IAAIiB,MAAMC,OAAO,CAACnB,WAAWoB,MAAM,CAACC,qBAAqB,GAAG;QAC1D,MAAMC,kBAAkBtB,WAAWoB,MAAM,CAACC,qBAAqB,CAACE,MAAM,CACpE,CAACC,KAAKC;YACJD,GAAG,CAACC,MAAM,GAAG;YACb,OAAOD;QACT,GACA,CAAC;QAGHrB,OAAOsB,KAAK,CAACH,iBAAiB;YAAEI,QAAQ;QAAK;IAC/C;IAEAvB,OACGwB,MAAM,CAAuB/B,UAAU;QAAEgC,mBAAmB;IAAK,GACjED,MAAM,CAAC9B,oBAAoB;QAAEgC,gBAAgB7B,WAAW8B,IAAI;IAAC;IAEhE,OAAO3B;AACT,EAAC"}