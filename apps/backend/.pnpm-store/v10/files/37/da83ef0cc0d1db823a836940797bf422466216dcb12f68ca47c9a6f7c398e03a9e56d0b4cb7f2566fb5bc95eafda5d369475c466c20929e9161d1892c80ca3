{"version":3,"file":"getIsLocked.js","names":["sanitizeID","getIsLocked","id","collectionConfig","globalConfig","isEditing","req","entityConfig","entityHasLockingEnabled","lockDocuments","undefined","isLocked","where","globalSlug","equals","slug","and","docs","payload","find","collection","depth","overrideAccess","length","newEditor","user","value","lastUpdateTime","Date","updatedAt","getTime","currentEditor"],"sources":["../../../src/views/Document/getIsLocked.ts"],"sourcesContent":["import type {\n  PayloadRequest,\n  SanitizedCollectionConfig,\n  SanitizedGlobalConfig,\n  TypedUser,\n  Where,\n} from 'payload'\n\nimport { sanitizeID } from '@payloadcms/ui/shared'\n\ntype Args = {\n  collectionConfig?: SanitizedCollectionConfig\n  globalConfig?: SanitizedGlobalConfig\n  id?: number | string\n  isEditing: boolean\n  req: PayloadRequest\n}\n\ntype Result = Promise<{\n  currentEditor?: TypedUser\n  isLocked: boolean\n  lastUpdateTime?: number\n}>\n\nexport const getIsLocked = async ({\n  id,\n  collectionConfig,\n  globalConfig,\n  isEditing,\n  req,\n}: Args): Result => {\n  const entityConfig = collectionConfig || globalConfig\n\n  const entityHasLockingEnabled =\n    entityConfig?.lockDocuments !== undefined ? entityConfig?.lockDocuments : true\n\n  if (!entityHasLockingEnabled || !isEditing) {\n    return {\n      isLocked: false,\n    }\n  }\n\n  const where: Where = {}\n\n  if (globalConfig) {\n    where.globalSlug = {\n      equals: globalConfig.slug,\n    }\n  } else {\n    where.and = [\n      {\n        'document.value': {\n          equals: sanitizeID(id),\n        },\n      },\n      {\n        'document.relationTo': {\n          equals: collectionConfig.slug,\n        },\n      },\n    ]\n  }\n\n  const { docs } = await req.payload.find({\n    collection: 'payload-locked-documents',\n    depth: 1,\n    overrideAccess: false,\n    req,\n    where,\n  })\n\n  if (docs.length > 0) {\n    const newEditor = docs[0].user?.value\n    const lastUpdateTime = new Date(docs[0].updatedAt).getTime()\n\n    if (newEditor?.id !== req.user.id) {\n      return {\n        currentEditor: newEditor,\n        isLocked: true,\n        lastUpdateTime,\n      }\n    }\n  }\n\n  return {\n    isLocked: false,\n  }\n}\n"],"mappings":"AAQA,SAASA,UAAU,QAAQ;AAgB3B,OAAO,MAAMC,WAAA,GAAc,MAAAA,CAAO;EAChCC,EAAE;EACFC,gBAAgB;EAChBC,YAAY;EACZC,SAAS;EACTC;AAAG,CACE;EACL,MAAMC,YAAA,GAAeJ,gBAAA,IAAoBC,YAAA;EAEzC,MAAMI,uBAAA,GACJD,YAAA,EAAcE,aAAA,KAAkBC,SAAA,GAAYH,YAAA,EAAcE,aAAA,GAAgB;EAE5E,IAAI,CAACD,uBAAA,IAA2B,CAACH,SAAA,EAAW;IAC1C,OAAO;MACLM,QAAA,EAAU;IACZ;EACF;EAEA,MAAMC,KAAA,GAAe,CAAC;EAEtB,IAAIR,YAAA,EAAc;IAChBQ,KAAA,CAAMC,UAAU,GAAG;MACjBC,MAAA,EAAQV,YAAA,CAAaW;IACvB;EACF,OAAO;IACLH,KAAA,CAAMI,GAAG,GAAG,CACV;MACE,kBAAkB;QAChBF,MAAA,EAAQd,UAAA,CAAWE,EAAA;MACrB;IACF,GACA;MACE,uBAAuB;QACrBY,MAAA,EAAQX,gBAAA,CAAiBY;MAC3B;IACF,EACD;EACH;EAEA,MAAM;IAAEE;EAAI,CAAE,GAAG,MAAMX,GAAA,CAAIY,OAAO,CAACC,IAAI,CAAC;IACtCC,UAAA,EAAY;IACZC,KAAA,EAAO;IACPC,cAAA,EAAgB;IAChBhB,GAAA;IACAM;EACF;EAEA,IAAIK,IAAA,CAAKM,MAAM,GAAG,GAAG;IACnB,MAAMC,SAAA,GAAYP,IAAI,CAAC,EAAE,CAACQ,IAAI,EAAEC,KAAA;IAChC,MAAMC,cAAA,GAAiB,IAAIC,IAAA,CAAKX,IAAI,CAAC,EAAE,CAACY,SAAS,EAAEC,OAAO;IAE1D,IAAIN,SAAA,EAAWtB,EAAA,KAAOI,GAAA,CAAImB,IAAI,CAACvB,EAAE,EAAE;MACjC,OAAO;QACL6B,aAAA,EAAeP,SAAA;QACfb,QAAA,EAAU;QACVgB;MACF;IACF;EACF;EAEA,OAAO;IACLhB,QAAA,EAAU;EACZ;AACF","ignoreList":[]}