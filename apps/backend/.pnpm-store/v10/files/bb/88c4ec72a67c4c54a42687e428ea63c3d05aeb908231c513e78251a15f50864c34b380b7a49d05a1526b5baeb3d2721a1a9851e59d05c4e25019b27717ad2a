{"version":3,"file":"handleServerFunction.js","names":["getClientConfig","headers","getHeaders","getAccessResults","isEntityHidden","parseCookies","renderDocument","renderDocumentHandler","args","collectionSlug","disableActions","docID","drawerSlug","initialData","locale","overrideEntityVisibility","paramsOverride","redirectAfterCreate","redirectAfterDelete","redirectAfterDuplicate","req","i18n","payload","config","user","searchParams","versions","cookies","incomingUserSlug","collection","adminUserSlug","admin","adminAccessFunction","collections","access","canAccessAdmin","Error","hasUsers","find","depth","limit","pagination","docs","length","clientConfig","importMap","preferences","preferencesKey","where","and","key","equals","id","then","res","value","visibleEntities","map","slug","hidden","filter","Boolean","globals","permissions","data","Document","documentSubViewType","initPageResult","collectionConfig","globalConfig","global","languageOptions","undefined","translations","params","segments","String","viewType"],"sources":["../../../src/views/Document/handleServerFunction.tsx"],"sourcesContent":["import type { RenderDocumentServerFunction } from '@payloadcms/ui'\nimport type { DocumentPreferences, VisibleEntities } from 'payload'\n\nimport { getClientConfig } from '@payloadcms/ui/utilities/getClientConfig'\nimport { headers as getHeaders } from 'next/headers.js'\nimport { getAccessResults, isEntityHidden, parseCookies } from 'payload'\n\nimport { renderDocument } from './index.js'\n\nexport const renderDocumentHandler: RenderDocumentServerFunction = async (args) => {\n  const {\n    collectionSlug,\n    disableActions,\n    docID,\n    drawerSlug,\n    initialData,\n    locale,\n    overrideEntityVisibility,\n    paramsOverride,\n    redirectAfterCreate,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    req,\n    req: {\n      i18n,\n      payload,\n      payload: { config },\n      user,\n    },\n    searchParams = {},\n    versions,\n  } = args\n\n  const headers = await getHeaders()\n\n  const cookies = parseCookies(headers)\n\n  const incomingUserSlug = user?.collection\n\n  const adminUserSlug = config.admin.user\n\n  // If we have a user slug, test it against the functions\n  if (incomingUserSlug) {\n    const adminAccessFunction = payload.collections[incomingUserSlug].config.access?.admin\n\n    // Run the admin access function from the config if it exists\n    if (adminAccessFunction) {\n      const canAccessAdmin = await adminAccessFunction({ req })\n\n      if (!canAccessAdmin) {\n        throw new Error('Unauthorized')\n      }\n      // Match the user collection to the global admin config\n    } else if (adminUserSlug !== incomingUserSlug) {\n      throw new Error('Unauthorized')\n    }\n  } else {\n    const hasUsers = await payload.find({\n      collection: adminUserSlug,\n      depth: 0,\n      limit: 1,\n      pagination: false,\n    })\n\n    // If there are users, we should not allow access because of /create-first-user\n    if (hasUsers.docs.length) {\n      throw new Error('Unauthorized')\n    }\n  }\n\n  const clientConfig = getClientConfig({\n    config,\n    i18n,\n    importMap: req.payload.importMap,\n  })\n\n  let preferences: DocumentPreferences\n\n  if (docID) {\n    const preferencesKey = `${collectionSlug}-edit-${docID}`\n\n    preferences = await payload\n      .find({\n        collection: 'payload-preferences',\n        depth: 0,\n        limit: 1,\n        where: {\n          and: [\n            {\n              key: {\n                equals: preferencesKey,\n              },\n            },\n            {\n              'user.relationTo': {\n                equals: user.collection,\n              },\n            },\n            {\n              'user.value': {\n                equals: user.id,\n              },\n            },\n          ],\n        },\n      })\n      .then((res) => res.docs[0]?.value as DocumentPreferences)\n  }\n\n  const visibleEntities: VisibleEntities = {\n    collections: payload.config.collections\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n    globals: payload.config.globals\n      .map(({ slug, admin: { hidden } }) => (!isEntityHidden({ hidden, user }) ? slug : null))\n      .filter(Boolean),\n  }\n\n  const permissions = await getAccessResults({\n    req,\n  })\n\n  const { data, Document } = await renderDocument({\n    clientConfig,\n    disableActions,\n    documentSubViewType: 'default',\n    drawerSlug,\n    i18n,\n    importMap: payload.importMap,\n    initialData,\n    initPageResult: {\n      collectionConfig: payload?.collections?.[collectionSlug]?.config,\n      cookies,\n      docID,\n      globalConfig: payload.config.globals.find((global) => global.slug === collectionSlug),\n      languageOptions: undefined, // TODO\n      locale,\n      permissions,\n      req,\n      translations: undefined, // TODO\n      visibleEntities,\n    },\n    overrideEntityVisibility,\n    params: paramsOverride ?? {\n      segments: ['collections', collectionSlug, String(docID)],\n    },\n    payload,\n    redirectAfterCreate,\n    redirectAfterDelete,\n    redirectAfterDuplicate,\n    searchParams,\n    versions,\n    viewType: 'document',\n  })\n\n  return {\n    data,\n    Document,\n    preferences,\n  }\n}\n"],"mappings":"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","ignoreList":[]}